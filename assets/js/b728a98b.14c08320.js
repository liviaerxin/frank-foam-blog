"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7191],{81149:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>l,default:()=>b,frontMatter:()=>m,metadata:()=>p,toc:()=>d});var a=t(87462),o=(t(67294),t(3905)),r=t(1841),s=t.n(r),i=t(64002);const m={authors:["frank"],tags:["docker","samba"],description:"Set Up Samba Server in Docker",keywords:["Set Up Samba Server in Docker"],image:"https://i.imgur.com/mErPwqL.png",date:new Date("2023-08-12T00:00:00.000Z"),draft:!1,enableComments:!0},l="Set Up Samba Server in Docker",p={permalink:"/blog/docker-setup-samba-server",editUrl:"https://github.com/liviaerxin/liviaerxin.github.io/edit/master/_ssg/docusaurus/../../blog/docker-setup-samba-server.mdx",source:"@site/../../blog/docker-setup-samba-server.mdx",title:"Set Up Samba Server in Docker",description:"Set Up Samba Server in Docker",date:"2023-08-12T00:00:00.000Z",formattedDate:"August 12, 2023",tags:[{label:"docker",permalink:"/blog/tags/docker"},{label:"samba",permalink:"/blog/tags/samba"}],readingTime:3.005,hasTruncateMarker:!1,authors:[{name:"Frank Chen",title:"Maintainer of Docusaurus",url:"https://github.com/liviaerxin",imageURL:"https://github.com/liviaerxin.png",key:"frank"}],frontMatter:{authors:["frank"],tags:["docker","samba"],description:"Set Up Samba Server in Docker",keywords:["Set Up Samba Server in Docker"],image:"https://i.imgur.com/mErPwqL.png",date:"2023-08-12T00:00:00.000Z",draft:!1,enableComments:!0},prevItem:{title:"Keyboard Shortcut Collection",permalink:"/blog/keyboard-shortcut-collection"},nextItem:{title:"Set Up NFS Sever In Docker",permalink:"/blog/docker-setup-nfs-sever"}},u={authorsImageUrls:[void 0]},d=[{value:"Start Samba Server in Docker",id:"start-samba-server-in-docker",level:2},{value:"Start Samba Client in Docker",id:"start-samba-client-in-docker",level:2},{value:"Start Samba Client which Create Volume in Docker",id:"start-samba-client-which-create-volume-in-docker",level:2},{value:"Use Case in Docker Compose",id:"use-case-in-docker-compose",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}],c={toc:d},k="wrapper";function b(e){let{components:n,...t}=e;return(0,o.kt)(k,(0,a.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"!IMPORTANT"),": Permission setting is very annoying but critical, sometimes you need take long time to fine tune it and debug.\n",(0,o.kt)("strong",{parentName:"p"},"!IMPORTANT"),": When setting up a Samba server in Docker in OSX, you will encounter problems such as ",(0,o.kt)("inlineCode",{parentName:"p"},"Operation not suppored")," when using ",(0,o.kt)("inlineCode",{parentName:"p"},"bind mount"),". Roughly saying, the reason is Docker run in a light VM in Mac and your Mac host uses a different file system(HFS+) compared to Linux(ext4 or similar). So switching to ",(0,o.kt)("inlineCode",{parentName:"p"},"volume mount")," will solve this potential problem."),(0,o.kt)("p",null,"Some takeaways about Permission:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Creating and deleting files is controlled by permissions on the directory."),(0,o.kt)("li",{parentName:"ul"},"Modifying the file is controlled by permissions on the file. You may have a mask which is removing the write privilege from the file.")),(0,o.kt)("p",null,"When I turned to set up Samba server locally, the main purpose is that I would like to integrate the Samba server into my Docker Compose project to mock a real remote Samba server, which will facilitate your local development in Docker environment."),(0,o.kt)("p",null,"So this blog will illustrate to set up a Samba server and a client, and test interaction between them."),(0,o.kt)("h2",{id:"start-samba-server-in-docker"},"Start Samba Server in Docker"),(0,o.kt)("p",null,"Here, we use Samba server image from ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/dperson/samba"},"dperson/samba"),". Although there is an alternative from ",(0,o.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/servercontainers/samba"},"ghcr.io/servercontainers/samba")," or ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/crazy-max/docker-samba"},"crazymax/samba")),(0,o.kt)("p",null,"In OSX, it's critical to use ",(0,o.kt)("inlineCode",{parentName:"p"},"volume mount")," and avoid using ",(0,o.kt)("inlineCode",{parentName:"p"},"bind mount")," as we mentioned above."),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"In OSX, due to the docker desktop itself is running in VM, it will cause some error like ",(0,o.kt)("inlineCode",{parentName:"p"},"Operation not supported")," when binding a local file folder via ",(0,o.kt)("inlineCode",{parentName:"p"},"bind mount")," even you set ",(0,o.kt)("inlineCode",{parentName:"p"},"777")," mask on the folder. So it's recommended to use ",(0,o.kt)("inlineCode",{parentName:"p"},"volume mount")," to bind to ",(0,o.kt)("inlineCode",{parentName:"p"},"/mnt")," in Samba server in OSX."),(0,o.kt)("p",{parentName:"admonition"},"Furthermore, the Samba server will log such message: ",(0,o.kt)("inlineCode",{parentName:"p"},"error reading meta xattr: Not supported"),".")),(0,o.kt)("p",null,"In Linux, it's okay to use either ",(0,o.kt)("inlineCode",{parentName:"p"},"volume mount")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"bind mount"),".  "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'docker run -it --rm \\\n    --name samba \\\n    -p 139:139 -p 445:445 \\\n    -v mnt:/mnt:z \\\n    dperson/samba \\\n    -p -s "Mount;/mnt;yes;no;yes" -u "bob;bobspasswd" -g "log level = 5"\n')),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},'-s "<Mount;/mnt>;yes;no;yes"')," means ","[browsable:yes;readonly:no;guest:yes]",'", which will allow the guest to ',(0,o.kt)("inlineCode",{parentName:"p"},"read")," and the user to ",(0,o.kt)("inlineCode",{parentName:"p"},"read/write"),"!")),(0,o.kt)("p",null,"Get the samba server IP address:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"$ docker inspect \\\n    -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' \\\n    samba\n172.17.0.2\n")),(0,o.kt)("h2",{id:"start-samba-client-in-docker"},"Start Samba Client in Docker"),(0,o.kt)("p",null,"Use ",(0,o.kt)("inlineCode",{parentName:"p"},"dperson/samba")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"busybox")," image,"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"docker run -it --rm --privileged dperson/samba bash\n")),(0,o.kt)("p",null,"or"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"docker run -it --rm --privileged busybox sh\n")),(0,o.kt)("p",null,"Inside the container:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'mkdir /smb_share\n\n# mount -t cifs //[server-ip]/[share-path] /[mount-point]\nmount -t cifs //172.17.0.2/Mount /smb_share -o rw,username=bob,password=bobspasswd\n\n# write file\necho "xxxx" > /smb_share/f.txt\n')),(0,o.kt)("h2",{id:"start-samba-client-which-create-volume-in-docker"},"Start Samba Client which Create Volume in Docker"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create a CIFS/Samba Volume")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"docker volume create \\\n    --driver local \\\n    --opt type=cifs \\\n    --opt device=//172.17.0.2/Mount \\\n    --opt o=username=bob,password=bobspasswd \\\n    --name samba-volume\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},'$ docker inspect samba-volume\n[\n    {\n        "CreatedAt": "2023-08-13T16:24:03Z",\n        "Driver": "local",\n        "Labels": null,\n        "Mountpoint": "/var/lib/docker/volumes/samba-volume/_data",\n        "Name": "samba-volume",\n        "Options": {\n            "device": "//172.17.0.2/Mount",\n            "o": "addr=username=bob,password=bobspasswd",\n            "type": "cifs"\n        },\n        "Scope": "local"\n    }\n]\n')),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Start a container using the created volume ",(0,o.kt)("inlineCode",{parentName:"li"},"samba-volume"),".")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"docker run -it --rm \\\n    -v samba-volume:/mnt \\\n    busybox \\\n    sh\n")),(0,o.kt)("h2",{id:"use-case-in-docker-compose"},"Use Case in Docker Compose"),(0,o.kt)(s(),{language:"yaml",title:"docker-compose-samba.yml",mdxType:"CodeBlock"},i.Z),(0,o.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,o.kt)("p",null,"When you mount an Samba Share in Linux, you may encounter error like ",(0,o.kt)("inlineCode",{parentName:"p"},"failed: Invalid argument"),","),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"bash-5.1# mount -t cifs //172.17.0.2/Mount /mnt/smb_share -o iocharset=utf8,rw,vers=1.0\nmount: mounting //172.17.0.2/Mount on /mnt/smb_share failed: Invalid argument\n")),(0,o.kt)("p",null,"You can use ",(0,o.kt)("inlineCode",{parentName:"p"},"dmesg")," to debug,"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sh"},"bash-5.1# dmesg\n[317258.750535] CIFS: Attempting to mount \\\\172.17.0.2\\Mount\n[317258.752956] CIFS: VFS: No username specified\n[317336.240984] cifs: Unknown parameter 'passwd'\n[317344.451345] CIFS: Attempting to mount \\\\172.17.0.2\\Mount\n")))}b.isMDXComponent=!0},64002:(e,n,t)=>{t.d(n,{Z:()=>a});const a='version: "3"\n\n# Inspired by https://github.com/dperson/samba/blob/master/docker-compose.yml\n\nservices:\n  samba:\n    image: dperson/samba\n    privileged: true\n    environment:\n      TZ: "EST5EDT"\n    ports:\n      - "137:137/udp"\n      - "138:138/udp"\n      - "139:139/tcp"\n      - "445:445/tcp"\n    volumes:\n      - mnt:/mnt:z\n    command: \'-s "Mount;/mnt;yes;no;yes" -u "bob;bobspasswd" -p\'\n    # networks:\n    #   default:\n    #     ipv4_address: 172.28.0.20\n\n  samba-client:\n    image: busybox\n    restart: on-failure\n    volumes:\n      - samba-volume:/smb_share\n    # tty: true\n    command: sleep infinity\n    depends_on:\n      - samba\n\n    # networks:\n    #   default:\n    #     ipv4_address: 172.28.0.21\n        \n# networks:\n#   default:\n#     driver: bridge\n#     ipam:\n#       config:\n#         - subnet: 172.28.0.0/16\n#           gateway: 172.28.0.1\n\nvolumes:\n  mnt:\n  samba-volume:\n    driver: local\n    driver_opts:\n      type: cifs\n      # device: "//172.28.0.20/Mount"\n      # o: "username=bob,password=bobspasswd"\n      device: "//localhost/Mount"\n      o: "addr=localhost,username=bob,password=bobspasswd"'}}]);